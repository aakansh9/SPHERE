require(xgboost)
require(dplyr)
require(data.table)
require(caret)

MOFO_GBTREE_EXPLORER <- function(seed, proj_name, f, nlags=0:4, c1, c2, d1, d2){
  
  source('~/SPHERE-Challenge/code/models/xgboost_functions.R')
  
  # folds
  folds = list(1:1753, 1754:3395, 3396:4911, 4912:6448, 6449:7955, 
               7956:9347, 9348:10852, 10853:12520, 12521:14345, 14346:16124)
  
  
  print('Loading train')
  # train
  fnames = list.files(path = 'data/working/L2_features/', pattern = '[a-zA-Z0-9_]+TR.csv$') %>% paste0('data/working/L2_features/',.)
  train = lapply(fnames, fread) %>% do.call(cbind, .) %>% data.frame
  #rem = remDupcols(train)
  #rem = c(1203,1204,1205,1206,1207,1208,1209,1210,1211,1212,1213,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,2188,2189,2190,2191,2192,2193,2194,2195,2196,2197,2198,2945,2946,2947,2948,2949,2950,2951,2952,2953,2954,2955,2956,2957,2958,2959,2960,2961,2962,2963,2964,2965,2966,2967,2968,2969,2970,3173,3174,3175,3176,3177,3178,3179,3180,3181,3182,3183,3930,3931,3932,3933,3934,3935,3936,3937,3938,3939,3940,3941,3942,3943,3944,3945,3946,3947,3948,3949,3950,3951,3952,3953,3954,3955,4158,4159,4160,4161,4162,4163,4164,4165,4166,4167,4168,4915,4916,4917,4918,4919,4920,4921,4922,4923,4924,4925,4926,4927,4928,4929,4930,4931,4932,4933,4934,4935,4936,4937,4938,4939,4940,5143,5144,5145,5146,5147,5148,5149,5150,5151,5152,5153,5900,5901,5902,5903,5904,5905,5906,5907,5908,5909,5910,5911,5912,5913,5914,5915,5916,5917,5918,5919,5920,5921,5922,5923,5924,5925,5926,6001,6002,6011,6087,6096,6172,6181,6256,6257,6266,6342,6351,6427,6436,6511,6512,6521,6597,6606,6682,6691,6766,6767,6776,6852,6861,6937,6946,7021,7022,7031,7107,7116,7192)
  #train = train[,-rem]
  train = train[,f]
  
  print('Loading test')
  # test
  fnames = list.files(path = 'data/working/L2_features/', pattern = '[a-zA-Z0-9_]+TT.csv$') %>% paste0('data/working/L2_features/',.)
  test = lapply(fnames, fread) %>% do.call(cbind, .) %>% data.frame
  #test = test[,-rem]
  test = test[,f]
  
  print('Loading target')
  # target
  traintarget = read.csv('data/working/features/train.target')[,-(1:4)]
  traintarget = traintarget[complete.cases(traintarget),]
  
  # params
  set.seed(seed)
  params = list(booster='gbtree', objective='reg:logistic', eta=runif(1, 0.05, 0.1),
                subsample=runif(1, 0.7, 0.99), colsample_bytree=runif(1, c1, c2),
                max_depth=sample(d1:d2, 1), max_delta_step = sample(0:5, 1), 
                verbose=1,silent=1,nthread=10)
  
  #set.seed(seed)
  #s = sample(1:ncol(train), 900)
  
  print('CVing')
  # cv
  set.seed(seed+1)
  cv = xgb1.cv(params = params, traindata = train, traintarget = traintarget,
               folds = folds, nrounds= 1000, prediction=T, early_stopping_rounds = 2)
  
  
  print('Final Modeling')
  # predict
  set.seed(seed+2)
  res = xgb1.train(params = params, train = train, traintarget = traintarget, test = test, nrounds = cv$best_nrounds)
  
  # correct pred
  samplesub = read.csv('data/raw_data/public_data/submission_uniform_baseline.csv')
  res$pred[which(samplesub$end %in% c(1:max(nlags))), ] = NA
  
  # feat imp
  imp = lapply(1:20, function(c) {
    imp = xgb.importance(feature_names = colnames(test), model = res$model[[c]])
    names(imp)[-1] = paste0(names(imp)[-1],'_',c)
    return(imp)
  }) %>% Reduce(function(...) merge(..., all=T, by='Feature'), .)
  
  print('Saving data')
  # save
  paras = data.frame(myparam_colsample_bytree = params$colsample_bytree,
                     myparam_subsample = params$subsample,
                     myparam_eta = params$eta,
                     myparam_max_depth = params$max_depth,
                     myparam_max_delta_step = params$max_delta_step,
                     best_nrounds = cv$best_nrounds,
                     best_score = paste0(cv$hist[[cv$best_nrounds]], collapse=' '),
                     best_cvtestmean = cv$hist[[cv$best_nrounds]][3])
  dir.create(paste0('data/working/LAGGER_MODELS/',proj_name), recursive = T)
  write.table(paras, paste0('data/working/LAGGER_MODELS/',proj_name,'/paras.csv'), sep = ",", row.names = FALSE, quote=F, col.names = T)
  write.table(cv$pred, paste0('data/working/LAGGER_MODELS/',proj_name,'/pred_TR.csv'), sep = ",", row.names = FALSE, quote=F, col.names = T)
  write.table(res$pred, paste0('data/working/LAGGER_MODELS/',proj_name,'/pred_TT.csv'), sep = ",", row.names = FALSE, quote=F, col.names = T)
  write.table(imp, paste0('data/working/LAGGER_MODELS/',proj_name,'/imp.csv'), sep = ",", row.names = FALSE, quote=F, col.names = T)
  
}

fnames = list.files(path = 'data/working/L2_features/', pattern = '[a-zA-Z0-9_]+TR.csv$') %>% paste0('data/working/L2_features/',.)
tmp = lapply(fnames[1:10], fread) %>% do.call(cbind, .) %>% data.frame
f = names(tmp)
MOFO_GBTREE_EXPLORER(seed = 1, proj_name = 'MOFO1_1000_XGBTREE', f = f, nlags = 0:4, c1=0.1, c2=0.9, d1=8, d2=15)
gc()

f = c(2,3,4,5,6,7,9,11,12,13,16,17,25,27,29,31,33,37,38,49,57,84,97,112,113,115,119,123,171,203,204,205,206,207,210,211,212,215,216,217,230,237,247,290,294,297,303,305,307,310,314,317,401,402,403,404,405,406,408,409,411,412,414,415,416,418,420,422,425,426,435,438,441,446,468,488,489,501,502,503,504,505,506,508,509,511,512,514,515,516,517,518,521,522,525,526,529,537,538,541,542,546,588,597,601,602,603,604,605,606,608,609,611,612,613,615,618,620,621,622,624,626,628,629,638,646,648,657,668,688,701,702,703,704,705,706,708,709,711,712,715,716,717,718,719,720,721,722,724,725,726,728,746,788,801,802,803,804,806,808,809,811,812,814,815,820,824,826,829,884,888,903,912,913,917,919,923,971,1017,1032,1058,1111,1123,1130,1164,1529,2055,2515)
MOFO_GBTREE_EXPLORER(seed = 2, proj_name = 'MOFO2_188_XGBTREE', f = f, nlags = 0:4, c1=0.95, c2=0.99, d1=3, d2=8)
gc()

f = c(1,2,3,4,5,6,7,8,9,10,11,12,13,16,17,18,19,22,24,25,27,29,31,32,33,37,38,39,41,49,50,51,52,57,59,67,68,69,72,81,84,89,93,97,98,103,106,112,113,115,116,118,119,120,123,126,133,151,168,171,201,203,204,205,206,207,208,210,211,212,214,215,216,217,219,224,230,232,237,247,250,267,270,271,288,289,290,294,297,302,303,305,307,310,314,317,338,347,386,401,402,403,404,405,406,408,409,410,411,412,413,414,415,416,417,418,420,421,422,425,426,435,438,441,442,446,468,481,488,489,494,497,501,502,503,504,505,506,508,509,511,512,514,515,516,517,518,520,521,522,523,524,525,526,529,531,537,538,541,542,546,561,571,577,584,588,589,597,598,601,602,603,604,605,606,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,624,625,626,628,629,633,635,638,646,648,649,657,668,669,688,694,701,702,703,704,705,706,708,709,710,711,712,714,715,716,717,718,719,720,721,722,723,724,725,726,728,729,742,746,748,749,766,788,797,798,801,802,803,804,805,806,808,809,811,812,814,815,816,817,820,821,822,824,826,829,844,846,849,869,884,888,891,903,906,912,913,915,916,917,918,919,920,923,933,937,951,968,971,991,1008,1017,1021,1024,1027,1032,1034,1041,1049,1051,1058,1067,1073,1085,1100,1111,1123,1130,1149,1164,1166,1176,1190,1510,1529,1530,1565,1599,2000,2009,2012,2055,2514,2515,2557,2997,3038,3479,4022,4023,4171,5015,5077,5118,5138,6106)
MOFO_GBTREE_EXPLORER(seed = 3, proj_name = 'MOFO3_330_XGBTREE', f = f, nlags = 0:4, c1=0.8, c2=0.99, d1=3, d2=8)
gc()


f = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,
      28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,44,45,46,47,48,49,50,51,52,
      53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,77,79,80,81,82,83,84,85,86,87,88,
      89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,
      120,122,123,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,143,146,147,148,149,150,151,152,153,154,156,157,159,
      160,161,165,166,167,168,169,170,171,172,173,174,175,176,177,179,180,181,182,185,186,187,188,189,190,191,192,193,195,196,197,198,199,200,201,202,
      203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,223,224,225,226,227,228,229,230,
      231,232,233,234,236,237,238,239,240,242,243,244,245,246,247,248,249,250,251,252,
      253,254,255,257,258,259,260,261,262,263,265,266,267,268,269,270,271,272,274,276,277,278,281,283,284,285,286,287,
      288,289,290,291,293,294,296,297,298,299,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,
      318,319,320,321,322,323,325,326,327,328,329,330,331,332,333,334,335,337,338,340,342,343,345,347,348,350,351,352,354,355,358,361,365,366,367,368,369,370,371,374,376,378,379,380,381,382,383,384,386,387,388,389,
      390,391,392,393,394,395,396,398,399,401,402,403,404,405,406,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,440,441,442,444,446,447,
      448,449,451,453,455,457,458,459,461,463,464,468,469,470,471,472,473,474,476,477,478,479,480,481,482,483,484,485,488,489,490,491,492,493,494,497,498,499,501,502,503,504,505,506,507,508,509,510,511,512,513,514,
      515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,546,547,548,549,550,551,552,553,555,557,559,561,563,564,566,569,570,571,572,573,574,576,
      577,581,582,583,584,586,588,589,590,591,592,593,594,595,597,598,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,628,629,630,631,632,633,634,635,636,637,
      638,639,640,641,642,644,646,647,648,649,650,651,652,653,654,657,658,659,660,661,663,664,666,667,668,669,670,671,673,674,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,697,698,
      699,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,734,735,736,737,738,739,740,742,746,747,748,749,750,751,752,753,754,755,756,
      757,758,761,762,763,764,765,766,767,768,769,770,771,773,775,777,778,780,781,783,784,787,788,789,790,791,792,793,794,795,797,798,799,801,802,803,804,805,806,808,809,810,811,812,813,814,815,816,817,818,819,820,
      821,822,823,824,826,827,828,829,830,831,832,833,834,835,837,838,839,840,841,842,844,845,846,847,848,849,850,851,852,854,856,857,859,860,861,866,867,868,869,871,872,875,876,878,880,883,884,886,887,888,889,891,
      894,898,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,923,925,926,928,929,932,933,935,936,937,938,939,940,941,943,944,946,948,949,950,951,952,954,955,957,961,963,966,
      968,969,971,972,975,976,977,978,979,980,981,982,988,989,990,991,992,993,995,997,998,999,1000,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1017,1019,1020,1021,1024,1025,1026,
      1027,1028,1029,1030,1031,1032,1033,1034,1036,1037,1038,1039,1040,1041,1042,1043,1045,1047,1049,1050,1051,1053,1054,1055,1056,1057,1058,1059,1061,1062,1065,1066,1067,1068,1069,1070,1071,1072,1073,1075,1076,1077,
      1078,1080,1081,1082,1083,1084,1085,1087,1089,1090,1091,1092,1093,1097,1099,1100,1101,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1115,1116,1117,1118,1120,1121,1122,1123,1124,1126,1127,1128,1129,1130,
      1131,1132,1134,1135,1136,1137,1138,1139,1140,1141,1144,1145,1147,1148,1149,1150,1151,1152,1153,1154,1155,1162,1164,1165,1166,1168,1169,1170,1171,1173,1176,1179,1185,1186,1187,1188,1190,1193,1195,1196,1199,1201,
      1250,1307,1399,1400,1401,1402,1403,1404,1471,1492,1494,1495,1498,1510,1511,1513,1518,1524,1529,1530,1533,1536,1539,1540,1541,1543,1544,1557,1562,1563,1565,1574,1575,1577,1578,1584,1585,1593,1594,1595,1596,1597,
      1598,1599,1602,1609,1611,1625,1631,1636,1640,1642,1643,1675,1682,1684,1708,1714,1719,1721,1773,1802,1810,1813,1823,1837,1851,1868,1872,1876,1881,1886,1890,1905,1908,1912,1914,1915,1916,1918,1919,1920,1923,1930,
      1939,1966,1986,1988,1989,1990,1991,1993,1994,1996,1997,1999,2000,2002,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2018,2019,2020,2021,2022,2023,2024,2026,2027,2030,2031,2032,2035,2039,2042,2044,
      2045,2046,2047,2048,2049,2050,2051,2052,2053,2054,2055,2056,2057,2058,2059,2060,2063,2064,2065,2066,2067,2068,2069,2070,2072,2073,2074,2075,2076,2077,2079,2080,2081,2082,2083,2086,2087,2088,2089,2091,2092,2095,
      2096,2098,2099,2100,2102,2105,2109,2111,2112,2113,2114,2115,2116,2117,2118,2119,2120,2121,2122,2123,2124,2125,2126,2128,2129,2130,2133,2134,2135,2136,2137,2144,2149,2150,2151,2153,2157,2160,2162,2165,2173,2174,
      2178,2180,2185,2206,2272,2303,2385,2386,2388,2476,2495,2496,2497,2498,2504,2505,2514,2515,2527,2528,2529,2538,2557,2571,2578,2607,2622,2684,2802,2808,2812,2832,2834,2836,2859,2875,2884,2901,2921,2971,2973,2974,
      2975,2977,2980,2981,2983,2984,2985,2986,2988,2989,2990,2992,2994,2995,2997,2998,2999,3001,3003,3004,3005,3006,3009,3010,3015,3016,3019,3021,3022,3023,3026,3027,3028,3029,3031,3032,3033,3035,3036,3037,3038,3040,
      3041,3042,3044,3045,3047,3048,3050,3051,3052,3053,3056,3058,3059,3060,3062,3063,3064,3065,3067,3068,3070,3071,3073,3078,3079,3080,3083,3089,3091,3097,3100,3102,3103,3104,3108,3109,3114,3122,3129,3134,3135,3140,
      3146,3149,3150,3152,3155,3156,3158,3159,3161,3167,3186,3192,3193,3199,3374,3404,3475,3476,3479,3480,3488,3499,3500,3502,3513,3529,3535,3564,3568,3576,3579,3669,3683,3821,3842,3860,3878,3902,3915,3957,3958,3960,
      3961,3962,3967,3968,3970,3972,3973,3974,3975,3977,3979,3981,3982,3983,3989,3991,3994,3996,3998,3999,4001,4004,4005,4006,4007,4010,4012,4013,4016,4017,4019,4021,4022,4023,4025,4028,4029,4030,4031,4032,4033,4039,
      4041,4045,4046,4047,4048,4052,4053,4054,4055,4057,4058,4063,4066,4067,4069,4071,4073,4074,4075,4078,4079,4081,4082,4083,4084,4085,4087,4088,4090,4093,4094,4096,4098,4103,4104,4105,4106,4107,4113,4114,4119,4120,
      4121,4122,4123,4128,4131,4132,4133,4140,4141,4142,4144,4171,4173,4176,4177,4302,4310,4465,4484,4485,4519,4520,4524,4530,4546,4564,4571,4579,4633,4645,4670,4696,4763,4784,4848,4903,4915,4941,4944,4945,4946,4948,
      4949,4950,4951,4954,4955,4956,4957,4959,4960,4962,4963,4964,4968,4970,4975,4977,4978,4979,4980,4983,4984,4989,4990,4993,4995,4996,4998,4999,5001,5002,5003,5006,5007,5008,5009,5013,5014,5015,5016,5017,5018,5020,
      5021,5025,5026,5029,5030,5031,5032,5033,5034,5035,5036,5037,5038,5042,5043,5045,5048,5052,5055,5060,5061,5063,5064,5065,5067,5068,5069,5071,5072,5073,5075,5077,5078,5079,5082,5083,5084,5086,5087,5088,5090,5091,
      5093,5095,5108,5112,5113,5114,5115,5118,5120,5126,5127,5129,5130,5133,5136,5138,5139,5156,5158,5159,5160,5163,5174,5200,5201,5309,5330,5408,5450,5453,5458,5464,5465,5470,5483,5524,5526,5527,5529,5534,5547,5560,
      5565,5571,5606,5612,5627,5644,5718,5768,5774,5817,5819,5847,5877,6007,6077,6099,6104,6106,6122,6139,6140,6143,6144,6145,6153,6154,6155,6156,6158,6164,6165,6174,6180,6283,6358,6360,6368,6371,6383,6410,6411,6414,
      6433,6435,6458,6621,6623,6629,6641,6648,6649,6685,6686,6817,6888,6895,6896,6910,6920,6922,6923,6942,6945,6964,6989,7049,7074,7124,7147,7152,7162,7170,7178,7179,7182)

MOFO_GBTREE_EXPLORER(seed = 4, proj_name = 'MOFO3_1681_XGBTREE', f = f, nlags = 0:4, c1=0.1, c2=0.9, d1=8, d2=15)
gc() 

